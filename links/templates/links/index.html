{% extends 'links/base.html' %}
{% block content %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

  <div class="md:col-span-2 space-y-4">

    <div class="bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-lg font-bold mb-3 text-gray-800">ğŸ“° ìƒˆë¡œìš´ ë‰´ìŠ¤ ì¶”ê°€</h2>

      <form
        hx-post="{% url 'htmx_link_create' %}"
        hx-trigger="submit"
        hx-target="#link-list"
        hx-select="#link-list"
        hx-swap="outerHTML"
        id="link-form"
        class="flex gap-2"
      >
        {% csrf_token %}
        <input
          type="url"
          name="url"
          placeholder="ë„¤ì´ë²„ ë‰´ìŠ¤ URL ì…ë ¥"
          required
          class="flex-1 p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm"
        />
        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-bold transition text-sm"
        >
          ì¶”ê°€
        </button>
      </form>

      <p class="text-xs text-gray-400 mt-1">
        ì…ë ¥í•˜ë©´ AIê°€ ìë™ ìš”ì•½í•©ë‹ˆë‹¤ (ì•½ 5~10ì´ˆ)
      </p>
    </div>

    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg border border-indigo-100">
      <h3 class="text-sm font-bold text-indigo-700 mb-3">âš¡ ë¹ ë¥¸ ì¶”ì²œ</h3>

      <div class="flex flex-wrap gap-2">
        
        <form hx-post="{% url 'htmx_recommend_interest' %}"
              hx-target="#link-list"
              hx-select="#link-list"
              hx-swap="outerHTML">
          {% csrf_token %}
          <button type="submit"
                  class="bg-purple-600 text-white px-4 py-2 rounded-md text-sm hover:bg-purple-700 transition">
            ğŸ¯ ê´€ì‹¬ì‚¬ ì¶”ì²œ
          </button>
        </form>

        <form hx-post="{% url 'htmx_recommend_explore' %}"
              hx-target="#link-list"
              hx-select="#link-list"
              hx-swap="outerHTML">
            {% csrf_token %}
            <button type="submit"
                    class="bg-emerald-600 text-white px-4 py-2 rounded-md text-sm hover:bg-emerald-700 transition">
              ğŸŒ± íƒí—˜ ì¶”ì²œ
            </button>
          </form>
      </div>
      
      <p class="text-xs text-gray-500 mt-2">
        * ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª©ë¡ ìƒë‹¨ì— ì§„í–‰ ìƒí™©ì´ í‘œì‹œë©ë‹ˆë‹¤.
      </p>
    </div>

  </div>

  <div class="bg-white p-5 rounded-lg shadow-md flex flex-col items-center justify-between">
    <h2 class="text-lg font-bold mb-2 text-gray-700">ğŸ“Š ë‚˜ì˜ ê´€ì‹¬ì‚¬ TOP 5</h2>

    <div class="w-full h-48 relative">
      <canvas id="tagChart"></canvas>
    </div>

    <a href="{% url 'stats_page' %}" 
       class="text-sm text-indigo-600 hover:underline mt-2 font-medium">
      ìƒì„¸ ë¶„ì„ ë³´ê¸° â†’
    </a>
  </div>

</div>

{% include 'links/partials/link_list.html' %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // [ìˆ˜ì •] document.body ëŒ€ì‹  documentë¥¼ ì‚¬ìš©í•˜ì—¬ null ì—ëŸ¬ ë°©ì§€
  document.addEventListener('htmx:afterRequest', function(evt) {
      // í¼ ì œì¶œ ì„±ê³µ ì‹œ ì…ë ¥ì°½ ë¹„ìš°ê¸°
      if(evt.detail.elt.id === 'link-form' && evt.detail.successful) {
          const input = document.querySelector('input[name="url"]');
          if(input) input.value = '';
      }
  });

  // ì°¨íŠ¸ ë Œë”ë§
  const ctx = document.getElementById('tagChart').getContext('2d');
  const labels = {{ chart_labels|safe }};
  const data = {{ chart_data|safe }};

  if (labels.length > 0) {
      new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: labels,
              datasets: [{
                  data: data,
                  backgroundColor: [
                      '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
                  ],
                  borderWidth: 0
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom',
                      labels: { boxWidth: 10, font: { size: 10 } }
                  }
              }
          }
      });
  }
</script>

{% endblock %}